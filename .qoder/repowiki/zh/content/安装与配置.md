# 安装与配置指南

<cite>
**本文档引用的文件**
- [requirements.txt](file://requirements.txt)
- [main.py](file://main.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [安装依赖包](#安装依赖包)
4. [环境变量配置](#环境变量配置)
5. [GitHub Token生成与配置](#github-token生成与配置)
6. [配置验证](#配置验证)
7. [GitHub Actions集成](#github-actions集成)
8. [故障排除](#故障排除)

## 简介

github_cve_monitor是一个用于自动监控GitHub上CVE信息的Python应用程序。本指南将详细介绍如何在本地环境中部署和配置该应用程序，确保您能够成功运行并充分利用其功能。

## 系统要求

- Python 3.6或更高版本
- pip包管理器
- Git（可选，用于克隆仓库）
- 至少2GB可用磁盘空间

## 安装依赖包

### 步骤1：创建虚拟环境（推荐）

为了保持系统环境整洁，建议在虚拟环境中安装依赖：

```bash
# 创建虚拟环境
python -m venv cve_monitor_env

# 激活虚拟环境
# Windows:
cve_monitor_env\Scripts\activate
# Linux/Mac:
source cve_monitor_env/bin/activate
```

### 步骤2：安装核心依赖包

项目需要两个核心依赖包：

1. **peewee==3.18.2** - 用于SQLite数据库操作
2. **requests==2.31.0** - 用于GitHub API调用

执行以下命令安装：

```bash
pip install -r requirements.txt
```

这个命令会自动安装`requirements.txt`文件中列出的所有依赖包。

**章节来源**
- [requirements.txt](file://requirements.txt#L1-L3)

## 环境变量配置

### GITHUB_TOKEN环境变量

GitHub API对未认证请求有严格的速率限制（每小时60次），而使用认证令牌可以将限制提升到每小时5000次。这是运行本应用程序的关键配置。

### Linux/Mac系统配置

在终端中执行以下命令：

```bash
export GITHUB_TOKEN=your_token_here
```

### Windows系统配置

在命令提示符中执行：

```cmd
set GITHUB_TOKEN=your_token_here
```

或者在PowerShell中：

```powershell
$env:GITHUB_TOKEN="your_token_here"
```

### 永久配置

#### Linux/Mac永久配置

编辑`~/.bashrc`或`~/.zshrc`文件：

```bash
echo 'export GITHUB_TOKEN=your_token_here' >> ~/.bashrc
source ~/.bashrc
```

#### Windows永久配置

1. 打开"系统属性" -> "高级" -> "环境变量"
2. 在"系统变量"下点击"新建"
3. 变量名：`GITHUB_TOKEN`
4. 变量值：`your_token_here`
5. 点击"确定"保存

**章节来源**
- [main.py](file://main.py#L130-L140)
- [README.md](file://README.md#L25-L35)

## GitHub Token生成与配置

### 生成GitHub Personal Access Token

1. 登录到您的GitHub账户
2. 点击右上角头像 -> "Settings"
3. 在左侧菜单选择"Developer settings" -> "Personal access tokens" -> "Tokens (classic)"
4. 点击"Generate new token" -> "Generate new token (classic)"
5. 选择所需的权限范围（至少需要`repo`权限）
6. 复制生成的Token值

### Token安全性注意事项

- 不要将Token提交到公共代码仓库
- 在生产环境中使用时，请考虑使用更安全的存储方式
- 定期轮换Token以提高安全性

### 程序内部实现机制

程序通过以下方式读取和使用Token：

```python
github_token = os.environ.get('GITHUB_TOKEN')
headers = {}

if github_token:
    headers['Authorization'] = f'token {github_token}'
    print(f"Using GitHub Token for authentication")
else:
    print("No GitHub Token found, using unauthenticated request")
```

当Token存在时，程序会在每个API请求中自动添加`Authorization: token YOUR_TOKEN`头，从而启用高频率API访问。

**章节来源**
- [main.py](file://main.py#L130-L145)

## 配置验证

### 验证Token是否正确加载

运行程序后，检查控制台输出中的DEBUG信息：

```bash
DEBUG: GITHUB_TOKEN is set. Value: ghp_...
Using GitHub Token for authentication (Year: 2024)
```

如果看到类似上面的输出，说明Token已正确加载。

### API速率限制检查

程序会自动打印当前的API速率限制状态：

```bash
API Rate Limit: 4999/5000
```

这表明您正在使用认证请求，且剩余配额充足。

### 配置测试

1. 运行程序：`python main.py`
2. 观察控制台输出
3. 检查数据库文件`db/cve.sqlite`是否创建
4. 查看生成的文档文件`docs/README.md`

**章节来源**
- [main.py](file://main.py#L130-L150)

## GitHub Actions集成

### 在GitHub Actions中配置Secrets

如果您计划使用GitHub Actions来定期运行此脚本，需要在仓库设置中配置Secret：

1. 进入仓库 -> Settings -> Secrets and variables -> Actions
2. 点击"New repository secret"
3. 名称：`GH_TOKEN`
4. 值：您的GitHub Personal Access Token
5. 点击"Add secret"

### 工作流配置

GitHub Actions工作流文件通常位于`.github/workflows/run.yml`，它会自动使用配置的`GH_TOKEN` Secret。

### 自动化优势

- 定期自动更新CVE监控数据
- 减少手动干预
- 提供持续监控能力
- 自动生成报告文件

**章节来源**
- [README.md](file://README.md#L35-L45)

## 故障排除

### 常见问题及解决方案

#### 1. Token未生效

**症状**：程序仍然使用未认证请求，API速率限制较低

**解决方法**：
- 确认环境变量设置正确
- 重新启动终端或IDE
- 检查Token格式是否正确

#### 2. 权限不足错误

**症状**：API请求返回403 Forbidden

**解决方法**：
- 检查Token权限范围
- 确保包含必要的`repo`权限
- 重新生成Token并更新环境变量

#### 3. 数据库连接错误

**症状**：无法创建或访问`db/cve.sqlite`文件

**解决方法**：
- 确保程序有写入权限
- 检查`db/`目录是否存在
- 确保磁盘空间充足

#### 4. 网络连接问题

**症状**：API请求超时或连接失败

**解决方法**：
- 检查网络连接
- 验证GitHub API服务状态
- 考虑使用代理设置

### 调试技巧

1. **启用详细日志**：修改程序中的日志级别
2. **检查环境变量**：使用`print(os.environ)`查看所有环境变量
3. **测试API连接**：使用简单的requests测试GitHub API
4. **验证Token**：直接在GitHub API中测试Token有效性

### 支持资源

- GitHub官方文档：https://docs.github.com/
- Python requests库文档：https://docs.python-requests.org/
- Peewee ORM文档：https://docs.peewee-orm.com/

通过遵循本指南，您应该能够在本地环境中成功部署和配置github_cve_monitor应用程序。如果遇到任何问题，请参考故障排除部分或查阅相关文档。