<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>统计数据测试</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .info { background: #d1ecf1; border-color: #bee5eb; }
    pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>🔍 统计数据测试页面</h1>
  
  <div id="results"></div>
  
  <script>
    const resultsDiv = document.getElementById('results');
    
    function addResult(title, content, type = 'info') {
      const div = document.createElement('div');
      div.className = `result ${type}`;
      div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
      resultsDiv.appendChild(div);
    }
    
    async function runTests() {
      addResult('🚀 开始测试', '正在测试各个数据源的可用性...');
      
      // 测试1: 检查README.md
      try {
        addResult('📋 测试README.md', '正在获取README.md...');
        const response = await fetch('./README.md');
        
        if (response.ok) {
          const text = await response.text();
          const lines = text.split('\\n');
          
          let info = {
            totalLines: lines.length,
            totalRecords: '未找到',
            generateTime: '未找到',
            tableRows: 0
          };
          
          // 分析前50行
          for (let i = 0; i < Math.min(50, lines.length); i++) {
            const line = lines[i];
            
            if (line.includes('总记录数')) {
              const match = line.match(/(\\d+)/);
              if (match) info.totalRecords = match[1];
            }
            
            if (line.includes('生成时间')) {
              const match = line.match(/(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2}:\\d{2})/);
              if (match) info.generateTime = match[1];
            }
            
            if (line.startsWith('| [CVE-')) {
              info.tableRows++;
            }
          }
          
          addResult('✅ README.md 成功', JSON.stringify(info, null, 2), 'success');
          
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        addResult('❌ README.md 失败', error.message, 'error');
      }
      
      // 测试2: 检查GitHub API
      try {
        addResult('🔗 测试GitHub API', '正在调用GitHub API...');
        const response = await fetch('https://api.github.com/repos/adminlove520/github_cve_monitor');
        
        if (response.ok) {
          const data = await response.json();
          
          let info = {
            name: data.name,
            created_at: data.created_at,
            updated_at: data.updated_at,
            stargazers_count: data.stargazers_count,
            forks_count: data.forks_count,
            rateLimitRemaining: response.headers.get('X-RateLimit-Remaining'),
            rateLimit: response.headers.get('X-RateLimit-Limit')
          };
          
          // 计算天数
          const createdDate = new Date(data.created_at);
          const now = new Date();
          const daysDiff = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
          info.monitoringDays = daysDiff;
          
          addResult('✅ GitHub API 成功', JSON.stringify(info, null, 2), 'success');
          
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        addResult('❌ GitHub API 失败', error.message, 'error');
      }
      
      // 测试3: 模拟统计数据计算
      try {
        addResult('🧮 模拟数据计算', '正在执行完整的数据获取逻辑...');
        
        let result = {
          totalCVEs: null,
          monitoringDays: null,
          systemUptime: null,
          apiLimit: null,
          dataSource: null
        };
        
        // 尝试GitHub API
        try {
          const apiResponse = await fetch('https://api.github.com/repos/adminlove520/github_cve_monitor');
          if (apiResponse.ok) {
            const repoData = await apiResponse.json();
            result.systemUptime = '100%';
            result.apiLimit = apiResponse.headers.get('X-RateLimit-Limit') || '5000';
            result.dataSource = 'GitHub API';
            
            // 计算监控天数
            const createdDate = new Date(repoData.created_at);
            const now = new Date();
            result.monitoringDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
            
            // 尝试获取README中的CVE数量
            try {
              const readmeResponse = await fetch('./README.md');
              if (readmeResponse.ok) {
                const markdown = await readmeResponse.text();
                const match = markdown.match(/总记录数.*?(\\d+)/);
                if (match) {
                  result.totalCVEs = parseInt(match[1]).toLocaleString();
                }
              }
            } catch (e) {
              console.warn('README读取失败:', e);
            }
          }
        } catch (apiError) {
          // 降级到README
          try {
            const readmeResponse = await fetch('./README.md');
            if (readmeResponse.ok) {
              const markdown = await readmeResponse.text();
              result.dataSource = 'README降级模式';
              result.systemUptime = '95%';
              result.apiLimit = '未知';
              
              const countMatch = markdown.match(/总记录数.*?(\\d+)/);
              if (countMatch) {
                result.totalCVEs = parseInt(countMatch[1]).toLocaleString();
              }
              
              const timeMatch = markdown.match(/生成时间.*?(\\d{4}-\\d{2}-\\d{2})/);
              if (timeMatch) {
                const updateDate = new Date(timeMatch[1]);
                const estimatedStart = new Date('2024-01-01');
                result.monitoringDays = Math.ceil((updateDate - estimatedStart) / (1000 * 60 * 60 * 24));
              }
            }
          } catch (readmeError) {
            throw new Error('所有数据源都失败');
          }
        }
        
        // 应用默认值
        result.totalCVEs = result.totalCVEs || '25000+';
        result.monitoringDays = Math.max(1, result.monitoringDays || 300);
        result.systemUptime = result.systemUptime || '95%';
        result.apiLimit = result.apiLimit || '5000';
        
        addResult('✅ 数据计算完成', JSON.stringify(result, null, 2), 'success');
        
      } catch (error) {
        addResult('❌ 数据计算失败', error.message, 'error');
      }
      
      addResult('🏁 测试完成', '所有测试已执行完毕');
    }
    
    // 页面加载后自动运行测试
    document.addEventListener('DOMContentLoaded', runTests);
  </script>
</body>
</html>