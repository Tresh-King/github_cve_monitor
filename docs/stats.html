<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>统计数据 - Github CVE Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid #EF3A38;
    }
    .header h1 {
      color: #EF3A38;
      margin: 0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #EF3A38, #ff6b6b);
      color: white;
      padding: 25px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card h3 {
      margin: 0;
      font-size: 2.5em;
      font-weight: 700;
    }
    .stat-card p {
      margin: 10px 0 0 0;
      opacity: 0.9;
      font-size: 1.1em;
    }
    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin: 20px 0;
      border: 1px solid #e9ecef;
    }
    .chart-title {
      color: #333;
      font-size: 1.3em;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
      height: 25px;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #EF3A38, #ff6b6b);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: 500;
      font-size: 0.9em;
    }
    .progress-label {
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    .trend-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .trend-table th, .trend-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .trend-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    .system-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .status-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    .status-icon {
      margin-right: 10px;
      font-size: 1.2em;
    }
    .status-text {
      font-weight: 500;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #EF3A38;
      text-decoration: none;
      font-weight: 500;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .coming-soon {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .coming-soon h3 {
      color: #856404;
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="./" class="back-link">← 返回首页</a>
    
    <div class="header">
      <h1>📊 统计数据</h1>
      <p style="color: #666;">CVE监控系统的数据统计和趋势分析</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="total-cves">📊 加载中...</h3>
        <p>总CVE记录数</p>
      </div>
      <div class="stat-card">
        <h3 id="days-running">⏰ 计算中...</h3>
        <p>监控天数</p>
      </div>
      <div class="stat-card">
        <h3 id="system-uptime">⚙️ 检测中...</h3>
        <p>系统可用性</p>
      </div>
      <div class="stat-card">
        <h3 id="api-limit">🔄 获取中...</h3>
        <p>API限制/小时</p>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">📈 CVE分类分布</div>
      <div id="cve-distribution">
        <div style="text-align: center; padding: 20px; color: #666;">
          🔄 正在分析CVE数据...
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">📅 每日增长趋势</div>
      <div id="daily-trend">
        <div style="text-align: center; padding: 20px; color: #666;">
          🔄 正在加载每日趋势数据...
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">🎯 本周热点CVE</div>
      <div id="hot-cves">
        <div style="text-align: center; padding: 20px; color: #666;">
          🔄 正在分析热点CVE...
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">🔧 系统状态</div>
      <div class="system-status">
        <div class="status-item">
          <span class="status-icon">✅</span>
          <span class="status-text">GitHub Actions</span>
        </div>
        <div class="status-item">
          <span class="status-icon">✅</span>
          <span class="status-text">API调用</span>
        </div>
        <div class="status-item">
          <span class="status-icon">✅</span>
          <span class="status-text">数据更新</span>
        </div>
        <div class="status-item">
          <span class="status-icon">✅</span>
          <span class="status-text">网站访问</span>
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">⚡ 性能指标</div>
      <div class="stats-grid">
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="color: #EF3A38; margin: 0;">~5分钟</h3>
          <p style="margin: 5px 0 0 0; color: #666;">平均处理时间</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="color: #EF3A38; margin: 0;">&lt;1小时</h3>
          <p style="margin: 5px 0 0 0; color: #666;">数据延迟</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="color: #EF3A38; margin: 0;">99.9%+</h3>
          <p style="margin: 5px 0 0 0; color: #666;">可用性</p>
        </div>
        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="color: #EF3A38; margin: 0;">&lt;5%</h3>
          <p style="margin: 5px 0 0 0; color: #666;">假阳性率</p>
        </div>
      </div>
    </div>
    
    <div class="coming-soon">
      <h3>🚀 即将推出</h3>
      <p><strong>统计功能完整版预计在 v2.2 版本中推出</strong></p>
      <ul style="text-align: left; display: inline-block; margin: 15px 0;">
        <li>📊 实时图表和可视化</li>
        <li>📈 趋势分析和预测</li>
        <li>🎯 自定义统计维度</li>
        <li>📱 交互式仪表板</li>
        <li>📧 统计报告订阅</li>
      </ul>
      <p>敬请期待！ ✨</p>
    </div>
    
    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e9ecef;">
      <p style="color: #666;">
        💡 数据来源: GitHub CVE数据库 | 更新频率: 每日 | 
        <a href="https://github.com/adminlove520/github_cve_monitor" target="_blank" style="color: #EF3A38;">GitHub仓库</a>
      </p>
    </div>
  </div>

  <script>
    // 动态加载统计数据
    async function loadDynamicStats() {
      try {
        // 加载主报告统计
        const readmeResponse = await fetch('README.md');
        if (readmeResponse.ok) {
          const markdown = await readmeResponse.text();
          const lines = markdown.split('\n');
          
          let totalRecords = '无数据';
          let updateTime = '未知';
          
          // 解析基本统计数据
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.includes('生成时间')) {
              const match = line.match(/(\d{4}-\d{2}-\d{2})/);
              if (match) updateTime = match[1];
            }
            if (line.includes('总记录数')) {
              const match = line.match(/(\d+)/);
              if (match) totalRecords = parseInt(match[1]).toLocaleString();
            }
          }
          
          // 更新CVE总数
          document.getElementById('total-cves').textContent = totalRecords + '+';
          
          // 获取仓库创建时间并计算监控天数
          const repoData = await apiResponse.json();
          const repoCreatedAt = new Date(repoData.created_at);
          
          // 计算监控天数
          if (updateTime !== '未知') {
            const currentDate = new Date(updateTime);
            const daysDiff = Math.ceil((currentDate - repoCreatedAt) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('days-running').textContent = Math.max(1, daysDiff);
          } else {
            // 如果无法获取更新时间，使用当前日期计算
            const currentDate = new Date();
            const daysDiff = Math.ceil((currentDate - repoCreatedAt) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('days-running').textContent = Math.max(1, daysDiff);
          }
        }
        
        // 加载系统状态
        try {
          const apiResponse = await fetch('https://api.github.com/repos/adminlove520/github_cve_monitor');
          if (apiResponse.ok) {
            document.getElementById('system-uptime').textContent = '100%';
            
            // 获取API限制信息
            const remainingRequests = apiResponse.headers.get('X-RateLimit-Remaining');
            const totalRequests = apiResponse.headers.get('X-RateLimit-Limit');
            if (totalRequests) {
              document.getElementById('api-limit').textContent = totalRequests;
            } else {
              document.getElementById('api-limit').textContent = '5000';
            }
          } else {
            document.getElementById('system-uptime').textContent = '检测失败';
            document.getElementById('api-limit').textContent = '未知';
          }
        } catch (systemError) {
          console.warn('系统状态检测失败:', systemError);
          document.getElementById('system-uptime').textContent = '无法检测';
          document.getElementById('api-limit').textContent = '无法获取';
        }
        
      } catch (error) {
        console.error('加载统计数据失败:', error);
        // 显示错误信息
        document.getElementById('total-cves').textContent = '加载失败';
        document.getElementById('days-running').textContent = '加载失败';
        document.getElementById('system-uptime').textContent = '加载失败';
        document.getElementById('api-limit').textContent = '加载失败';
      }
    }
    
    // 分析CVE数据并生成分类统计
    async function analyzeCVEData() {
      try {
        const response = await fetch('README.md');
        if (!response.ok) throw new Error('无法加载README.md');
        
        const markdown = await response.text();
        const lines = markdown.split('\n');
        
        // 查找表格数据
        const tableStart = markdown.indexOf('| CVE | 相关仓库');
        if (tableStart === -1) {
          throw new Error('未找到CVE表格数据');
        }
        
        const tableSection = markdown.substring(tableStart);
        const tableLines = tableSection.split('\n').slice(2); // 跳过表头
        
        // 参考mpvulnHub的分类体系，建立更详细的CVE分类规则
        const categories = {
          '漏洞利用与攻击': 0,
          '威胁情报与APT': 0,
          '应急响应与溯源': 0,
          '安全运营管理': 0,
          '红蓝队攻防': 0,
          '恶意软件分析': 0,
          '数据安全隐私': 0,
          '云安全新技术': 0,
          '应用系统安全': 0,
          '工业基础设施': 0,
          '安全工具技术': 0,
          '其他类型': 0
        };
        
        // 关键词分类规则 - 参考mpvulnHub的关键词匹配体系
        const classificationRules = {
          '漏洞利用与攻击': [
            'rce', 'remote code execution', 'command execution', 'code injection', 'command injection',
            'sql injection', 'sqli', 'xss', 'cross site scripting', 'csrf', 'ssrf',
            'file upload', 'file inclusion', 'lfi', 'rfi', 'path traversal', 'directory traversal',
            'buffer overflow', 'heap overflow', 'stack overflow', 'format string',
            'privilege escalation', 'elevation', 'bypass', 'authentication bypass',
            'unauthorized access', 'access control', 'logic flaw', 'race condition',
            '复现', '漏洞', '漏洞利用', '漏洞挖掘', '注入', '越权', '绕过', '溢出'
          ],
          '威胁情报与APT': [
            'apt', 'threat intelligence', 'malware', 'trojan', 'backdoor', 'botnet',
            'threat hunting', 'threat detection', 'ioc', 'indicator', 'campaign',
            'attribution', 'threat actor', 'advanced persistent threat',
            '威胁情报', 'APT攻击', '恶意软件', '木马', '后门', '僵尸网络', '威胁检测'
          ],
          '应急响应与溯源': [
            'incident response', 'forensics', 'digital forensics', 'incident handling',
            'attack attribution', 'threat hunting', 'evidence', 'timeline',
            'incident analysis', 'breach response', 'containment',
            '应急响应', '溯源分析', '数字取证', '事件响应', '攻击溯源', '证据收集'
          ],
          '安全运营管理': [
            'security operations', 'secops', 'soc', 'siem', 'soar', 'security monitoring',
            'vulnerability management', 'patch management', 'compliance',
            'security governance', 'risk assessment', 'security audit',
            '安全运营', '安全管理', '合规', '风险评估', '安全审计', '漏洞管理'
          ],
          '红蓝队攻防': [
            'red team', 'blue team', 'purple team', 'penetration test', 'pentest',
            'security assessment', 'attack simulation', 'defensive',
            'adversary simulation', 'tabletop exercise',
            '红队', '蓝队', '渗透测试', '攻防演练', '安全评估'
          ],
          '恶意软件分析': [
            'malware analysis', 'reverse engineering', 'dynamic analysis', 'static analysis',
            'sandbox', 'unpacking', 'obfuscation', 'ransomware', 'crypto',
            'virus', 'worm', 'adware', 'spyware',
            '恶意代码', '逆向工程', '勒索软件', '病毒', '蠕虫', '间谍软件'
          ],
          '数据安全隐私': [
            'data breach', 'data leak', 'privacy', 'gdpr', 'pii', 'personal data',
            'encryption', 'cryptography', 'key management', 'certificate',
            'authentication', 'authorization', 'identity', 'access control',
            '数据泄露', '隐私保护', '加密', '身份认证', '访问控制', '密钥管理'
          ],
          '云安全新技术': [
            'cloud security', 'container security', 'kubernetes', 'docker',
            'devsecops', 'serverless', 'microservices', 'api security',
            'zero trust', 'artificial intelligence', 'machine learning', 'ai security',
            '云安全', '容器安全', '微服务', 'AI安全', '零信任', 'API安全'
          ],
          '应用系统安全': [
            'web security', 'application security', 'mobile security', 'api',
            'web application', 'mobile app', 'ios', 'android',
            'code review', 'static analysis', 'dynamic analysis',
            'Web安全', '应用安全', '移动安全', '代码审计'
          ],
          '工业基础设施': [
            'iot security', 'industrial security', 'scada', 'ics', 'ot security',
            'smart grid', 'critical infrastructure', 'operational technology',
            'industrial control', 'automation', 'embedded',
            '物联网安全', '工业安全', '关键基础设施', '工控安全'
          ],
          '安全工具技术': [
            'security tool', 'scanner', 'detection tool', 'analysis tool',
            'automation', 'orchestration', 'integration', 'framework',
            'open source', 'commercial tool', 'custom tool',
            '安全工具', '扫描器', '检测工具', '自动化', '开源工具'
          ]
        };
        
        let totalCVEs = 0;
        const hotCVEs = [];
        
        // 智能分析每个CVE记录 - 使用多维度关键词匹配
        for (let i = 0; i < Math.min(tableLines.length, 1000); i++) { // 增加分析数量
          const line = tableLines[i].trim();
          if (line && line.startsWith('|')) {
            const cols = line.split('|').map(col => col.trim()).filter(col => col);
            if (cols.length >= 3) {
              totalCVEs++;
              const cveId = cols[0];
              const repoInfo = cols[1].toLowerCase();
              const description = cols[2].toLowerCase();
              
              // 合并所有文本信息进行分析
              const fullText = `${cveId} ${repoInfo} ${description}`.toLowerCase();
              
              let classified = false;
              
              // 使用智能关键词匹配进行分类
              for (const [category, keywords] of Object.entries(classificationRules)) {
                if (!classified) {
                  for (const keyword of keywords) {
                    if (fullText.includes(keyword.toLowerCase())) {
                      categories[category]++;
                      classified = true;
                      break;
                    }
                  }
                }
              }
              
              // 如果没有匹配到任何分类，归入其他类型
              if (!classified) {
                categories['其他类型']++;
              }
              
              // 收集热点CVE（前20个，用于后续分析）
              if (hotCVEs.length < 20) {
                const cveMatch = cols[0].match(/\[([^\]]+)\]/);
                const cveId = cveMatch ? cveMatch[1] : cols[0];
                
                // 提取GitHub仓库链接
                const repoLinkMatch = cols[1].match(/\[([^\]]+)\]\(([^)]+)\)/);
                const repoName = repoLinkMatch ? repoLinkMatch[1] : cols[1];
                const repoUrl = repoLinkMatch ? repoLinkMatch[2] : cols[1];
                
                // 计算热度评分
                let hotScore = 0;
                
                // 基于关键词的热度评分
                const highRiskKeywords = ['rce', 'remote code execution', 'critical', 'high', '严重', '高危'];
                const mediumRiskKeywords = ['bypass', 'privilege', 'elevation', 'unauthorized', '绕过', '提权'];
                const trendsKeywords = ['2025','2024', '2023', 'new', 'recent', 'latest', '最新', '新发现'];
                
                for (const keyword of highRiskKeywords) {
                  if (fullText.includes(keyword)) hotScore += 10;
                }
                for (const keyword of mediumRiskKeywords) {
                  if (fullText.includes(keyword)) hotScore += 5;
                }
                for (const keyword of trendsKeywords) {
                  if (fullText.includes(keyword)) hotScore += 3;
                }
                
                // 根据CVE编号年份调整热度
                const yearMatch = cveId.match(/CVE-(\d{4})/);
                if (yearMatch) {
                  const year = parseInt(yearMatch[1]);
                  const currentYear = new Date().getFullYear();
                  if (year === currentYear) hotScore += 15;
                  else if (year === currentYear - 1) hotScore += 10;
                  else if (year >= currentYear - 2) hotScore += 5;
                }
                
                hotCVEs.push({
                  id: cveId,
                  description: cols[2],
                  repo: repoUrl || repoName, // 优先使用URL，如果没有则使用名称
                  hotScore: hotScore,
                  category: classified ? Object.keys(categories).find(cat => 
                    classificationRules[cat].some(keyword => fullText.includes(keyword.toLowerCase()))
                  ) : '其他类型'
                });
              }
            }
          }
        }
        
        // 渲染CVE分类分布
        renderCVEDistribution(categories, totalCVEs);
        
        // 渲染热点CVE
        renderHotCVEs(hotCVEs);
        
      } catch (error) {
        console.error('分析CVE数据失败:', error);
        document.getElementById('cve-distribution').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #dc3545;">
            🚨 分析失败: ${error.message}
          </div>
        `;
        document.getElementById('hot-cves').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #dc3545;">
            🚨 加载失败: ${error.message}
          </div>
        `;
      }
    }
    
    // 渲染CVE分类分布图 - 使用更丰富的颜色和更好的视觉效果
    function renderCVEDistribution(categories, total) {
      const container = document.getElementById('cve-distribution');
      let html = '';
      
      // 按数量排序分类
      const sortedCategories = Object.entries(categories)
        .sort(([,a], [,b]) => b - a)
        .filter(([, count]) => count > 0); // 只显示有数据的分类
      
      if (sortedCategories.length === 0) {
        html = `<div style="text-align: center; padding: 20px; color: #666;">📄 暂无CVE分类数据</div>`;
      } else {
        // 定义更丰富的颜色方案 - 参考专业安全领域配色
        const colors = {
          '漏洞利用与攻击': '#EF3A38',    // 红色 - 最高危险
          '威胁情报与APT': '#ff4757',      // 深红色 - 高危险
          '应急响应与溯源': '#ff6348',    // 橙红色 - 紧急
          '安全运营管理': '#ffa502',     // 橙色 - 管理
          '红蓝队攻防': '#ff7675',       // 粉红色 - 攻防
          '恶意软件分析': '#e17055',    // 棕色 - 恶意
          '数据安全隐私': '#6c5ce7',    // 紫色 - 隐私
          '云安全新技术': '#00b894',    // 绿色 - 新技术
          '应用系统安全': '#0984e3',    // 蓝色 - 应用
          '工业基础设施': '#fdcb6e',    // 黄色 - 基础设施
          '安全工具技术': '#74b9ff',    // 浅蓝色 - 工具
          '其他类型': '#636e72'           // 灰色 - 其他
        };
        
        // 添加统计概览
        html += `
          <div style="margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #EF3A38;">
            <h4 style="margin: 0 0 10px 0; color: #333;">📈 分类统计概览</h4>
            <p style="margin: 0; color: #666;">
              总计 <strong style="color: #EF3A38;">${total}</strong> 个CVE，
              已分类为 <strong style="color: #EF3A38;">${sortedCategories.length}</strong> 个主要类别
            </p>
          </div>
        `;
        
        sortedCategories.forEach(([category, count]) => {
          const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
          const color = colors[category] || '#6c757d';
          
          // 计算相对安全等级
          let riskLevel = '低危';
          let riskIcon = '🟢';
          if (category.includes('漏洞利用') || category.includes('威胁情报')) {
            riskLevel = '高危';
            riskIcon = '🔴';
          } else if (category.includes('应急响应') || category.includes('恶意软件')) {
            riskLevel = '中危';
            riskIcon = '🟡';
          }
          
          html += `
            <div style="margin-bottom: 20px;">
              <div class="progress-label" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; color: #333;">
                  ${riskIcon} ${category}
                </span>
                <span style="color: #666; font-size: 0.9em;">
                  ${count}个 (${percentage}%) 
                  <span style="background: ${color}; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; margin-left: 5px;">
                    ${riskLevel}
                  </span>
                </span>
              </div>
              <div class="progress-bar" style="height: 30px; position: relative; background: #e9ecef; border-radius: 15px; overflow: hidden;">
                <div class="progress-fill" style="
                  width: ${Math.max(percentage, 2)}%; 
                  background: linear-gradient(135deg, ${color}, ${color}dd);
                  height: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: flex-end;
                  padding-right: 12px;
                  color: white;
                  font-weight: 600;
                  font-size: 0.9em;
                  transition: all 0.6s ease;
                  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
                ">${percentage}%</div>
              </div>
            </div>
          `;
        });
        
        // 添加分类说明
        html += `
          <div style="margin-top: 25px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #0984e3;">
            <h5 style="margin: 0 0 10px 0; color: #0984e3;">📁 分类说明</h5>
            <p style="margin: 0; color: #555; font-size: 0.9em; line-height: 1.6;">
              参考 <strong>mpvulnHub</strong> 的专业安全分类体系，采用多维度关键词匹配算法，
              对CVE进行智能分类。分类结果可以帮助安全团队更好地理解威胁景观和关注重点。
            </p>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // 渲染热点CVE - 使用智能热度评分系统
    function renderHotCVEs(hotCVEs) {
      const container = document.getElementById('hot-cves');
      
      if (hotCVEs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            📄 暂无热点CVE数据
          </div>
        `;
        return;
      }
      
      // 按热度评分排序，取前8个
      const topHotCVEs = hotCVEs
        .sort((a, b) => b.hotScore - a.hotScore)
        .slice(0, 8);
      
      // 定义热度等级和颜色
      const getHeatLevel = (score) => {
        if (score >= 25) return { level: '极热', color: '#EF3A38', icon: '🔥🔥🔥' };
        if (score >= 15) return { level: '高热', color: '#ff6348', icon: '🔥🔥' };
        if (score >= 8) return { level: '中热', color: '#ffa502', icon: '🔥' };
        return { level: '低热', color: '#74b9ff', icon: '🟡' };
      };
      
      // 分类颜色映射
      const categoryColors = {
        '漏洞利用与攻击': '#EF3A38',
        '威胁情报与APT': '#ff4757',
        '应急响应与溯源': '#ff6348',
        '安全运营管理': '#ffa502',
        '红蓝队攻防': '#ff7675',
        '恶意软件分析': '#e17055',
        '数据安全隐私': '#6c5ce7',
        '云安全新技术': '#00b894',
        '应用系统安全': '#0984e3',
        '工业基础设施': '#fdcb6e',
        '安全工具技术': '#74b9ff',
        '其他类型': '#636e72'
      };
      
      let html = `
        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
          <h4 style="margin: 0 0 10px 0; color: #856404;">🏆 热点CVE排行榜</h4>
          <p style="margin: 0; color: #856404; font-size: 0.9em;">
            基于危险等级、时间新近度、关键词匹配等多个维度计算热度评分，帮助您关注最重要的安全威胁。
          </p>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px;">
      `;
      
      topHotCVEs.forEach((cve, index) => {
        const heatInfo = getHeatLevel(cve.hotScore);
        const categoryColor = categoryColors[cve.category] || '#636e72';
        
        // 截断描述文本
        const truncatedDesc = cve.description.length > 120 
          ? cve.description.substring(0, 120) + '...' 
          : cve.description;
        
        // 排名徽章
        let rankBadge = '';
        if (index === 0) rankBadge = '🥇';
        else if (index === 1) rankBadge = '🥈';
        else if (index === 2) rankBadge = '🥉';
        else rankBadge = `🔢 ${index + 1}`;
        
        html += `
          <div style="
            padding: 20px; 
            background: white; 
            border-radius: 12px; 
            border: 2px solid ${heatInfo.color}; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';">
            
            <!-- 排名徽章 -->
            <div style="position: absolute; top: -10px; left: 15px; background: ${heatInfo.color}; color: white; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.85em;">
              ${rankBadge}
            </div>
            
            <!-- CVE信息头部 -->
            <div style="margin-top: 10px; margin-bottom: 15px;">
              <h4 style="margin: 0 0 8px 0; color: ${heatInfo.color}; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                <a href="https://www.cve.org/CVERecord?id=${cve.id}" target="_blank" style="
                  font-family: 'Courier New', monospace; 
                  font-weight: bold;
                  color: ${heatInfo.color};
                  text-decoration: none;
                  border-bottom: 1px dotted ${heatInfo.color};
                " onmouseover="this.style.textDecoration='underline';" onmouseout="this.style.textDecoration='none';">
                  ${cve.id}
                </a>
                <span style="font-size: 0.9em;">${heatInfo.icon}</span>
              </h4>
              
              <!-- 热度和分类标签 -->
              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <span style="
                  background: ${heatInfo.color}; 
                  color: white; 
                  padding: 3px 8px; 
                  border-radius: 12px; 
                  font-size: 0.75em; 
                  font-weight: 600;
                ">
                  ${heatInfo.level} (${cve.hotScore}分)
                </span>
                <span style="
                  background: ${categoryColor}; 
                  color: white; 
                  padding: 3px 8px; 
                  border-radius: 12px; 
                  font-size: 0.75em; 
                  font-weight: 500;
                ">
                  ${cve.category}
                </span>
              </div>
            </div>
            
            <!-- CVE描述 -->
            <p style="
              margin: 0 0 12px 0; 
              color: #555; 
              line-height: 1.5; 
              font-size: 0.9em;
              background: #f8f9fa;
              padding: 12px;
              border-radius: 8px;
              border-left: 3px solid ${heatInfo.color};
            ">
              ${truncatedDesc}
            </p>
            
            <!-- 相关仓库信息 -->
            <div style="
              color: #666; 
              font-size: 0.8em; 
              padding: 8px 12px;
              background: #e9ecef;
              border-radius: 6px;
              display: flex;
              align-items: center;
              gap: 6px;
            ">
              <span>💾</span>
              <span>相关仓库：</span>
              <a href="${cve.repo.startsWith('http') ? cve.repo : 'https://github.com/' + cve.repo}" 
                 target="_blank" 
                 style="
                   font-family: 'Courier New', monospace;
                   color: #0366d6;
                   text-decoration: none;
                   border-bottom: 1px dotted #0366d6;
                 " 
                 onmouseover="this.style.textDecoration='underline';" 
                 onmouseout="this.style.textDecoration='none';">
                ${cve.repo.replace('https://github.com/', '').replace('http://github.com/', '')}
              </a>
            </div>
          </div>
        `;
      });
      
      html += `
        </div>
        
        <!-- 热度评分说明 -->
        <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6c757d;">
          <h5 style="margin: 0 0 10px 0; color: #495057;">📊 热度评分算法</h5>
          <div style="color: #666; font-size: 0.9em; line-height: 1.6;">
            <p style="margin: 0 0 8px 0;">• <strong>高危关键词</strong>：rce, critical, high 等 (+10分)</p>
            <p style="margin: 0 0 8px 0;">• <strong>中危关键词</strong>：bypass, privilege, unauthorized 等 (+5分)</p>
            <p style="margin: 0 0 8px 0;">• <strong>时间新近度</strong>：当年CVE (+15分)，去年 (+10分)，近两年 (+5分)</p>
            <p style="margin: 0;">• <strong>趋势关键词</strong>：new, latest, recent 等 (+3分)</p>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // 加载每日趋势数据
    async function loadDailyTrend() {
      try {
        // 获取Data目录下的所有报告
        const apiUrl = 'https://api.github.com/repos/adminlove520/github_cve_monitor/contents/docs/Data';
        const response = await fetch(apiUrl);
        
        if (!response.ok) throw new Error('GitHub API调用失败');
        
        const data = await response.json();
        const directories = data.filter(item => item.type === 'dir' && item.name.match(/\d{4}-W\d{2}-\d{2}-\d{2}/))
                               .map(dir => ({
                                 name: dir.name,
                                 date: dir.name.split('-').slice(-2).join('-')
                               }))
                               .sort((a, b) => b.date.localeCompare(a.date))
                               .slice(0, 7); // 只取最近7天
        
        const trendData = [];
        
        // 为每个目录获取报告数据
        for (const dir of directories) {
          try {
            const dirResponse = await fetch(`https://api.github.com/repos/adminlove520/github_cve_monitor/contents/docs/Data/${dir.name}`);
            if (dirResponse.ok) {
              const dirData = await dirResponse.json();
              const reportFile = dirData.find(file => file.name.startsWith('daily_') && file.name.endsWith('.md'));
              
              if (reportFile) {
                const reportResponse = await fetch(reportFile.download_url);
                if (reportResponse.ok) {
                  const reportContent = await reportResponse.text();
                  const lines = reportContent.split('\n');
                  
                  let dailyCount = 0;
                  for (const line of lines.slice(0, 20)) {
                    if (line.includes('总记录数')) {
                      const match = line.match(/(\d+)/);
                      if (match) dailyCount = parseInt(match[1]);
                      break;
                    }
                  }
                  
                  trendData.push({
                    date: dir.date,
                    count: dailyCount,
                    total: dailyCount // 这里简化处理，实际上需要累计
                  });
                }
              }
            }
          } catch (dirError) {
            console.warn(`加载目录 ${dir.name} 失败:`, dirError);
          }
        }
        
        // 渲染趋势表格
        renderDailyTrend(trendData);
        
      } catch (error) {
        console.error('加载每日趋势失败:', error);
        document.getElementById('daily-trend').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #dc3545;">
            🚨 加载失败: ${error.message}
          </div>
        `;
      }
    }
    
    // 渲染每日趋势表格
    function renderDailyTrend(trendData) {
      const container = document.getElementById('daily-trend');
      
      if (trendData.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #666;">
            📄 暂无趋势数据
          </div>
        `;
        return;
      }
      
      let html = `
        <table class="trend-table">
          <thead>
            <tr>
              <th>日期</th>
              <th>新增CVE</th>
              <th>累计CVE</th>
              <th>增长率</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      trendData.forEach((day, index) => {
        const prevDay = trendData[index + 1];
        const growthRate = prevDay && prevDay.count > 0 
          ? ((day.count - prevDay.count) / prevDay.count * 100).toFixed(1) + '%'
          : '-';
        
        html += `
          <tr>
            <td>${day.date}</td>
            <td>${day.count.toLocaleString()}</td>
            <td>${day.total.toLocaleString()}</td>
            <td>${growthRate}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    // 加载并解析stats.md文件
    async function loadStats() {
      try {
        const response = await fetch('stats.md');
        const markdown = await response.text();
        
        // stats.md 目前只有 "# COMING SOON"，所以保留当前的预览内容
        // 在页面底部添加链接到原始文件
        const footer = document.querySelector('.container > div:last-child');
        if (footer) {
          footer.innerHTML += `
            <br><p style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
              📄 <a href="stats.md" target="_blank" style="color: #EF3A38;">查看原始统计数据文件</a>
            </p>
          `;
        }
        
      } catch (error) {
        console.error('加载stats.md失败:', error);
      }
    }
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function() {
      await Promise.all([
        loadDynamicStats(),
        loadStats(),
        analyzeCVEData(),
        loadDailyTrend()
      ]);
    });
  </script>
</body>
</html>